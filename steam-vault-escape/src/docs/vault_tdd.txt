# Steam Vault Escape - Technical Design Document

**Version:** 1.0  
**Date:** December 28, 2024  
**Status:** Pre-Production

---

## Architecture Overview

### **Tech Stack:**
- **Frontend:** Next.js 14 (React 18, TypeScript)
- **Styling:** TailwindCSS
- **State Management:** React useState/useEffect (no external library)
- **Data Persistence:** Browser localStorage
- **External APIs:** Steam Web API
- **Deployment:** Vercel
- **Version Control:** Git/GitHub

### **Project Structure:**
```
steam-vault-escape/
├── src/
│   ├── app/
│   │   ├── page.tsx                 # Main idle game page
│   │   ├── layout.tsx               # Root layout
│   │   ├── globals.css              # Global styles
│   │   └── api/
│   │       └── steam-library/
│   │           └── route.ts         # Fetch Steam library
│   ├── components/
│   │   ├── TheVault.tsx             # Main idle game component
│   │   ├── GameGrid.tsx             # Virtual scrolling grid
│   │   ├── GameCard.tsx             # Individual game display
│   │   ├── FeaturedGame.tsx         # Enlarged featured game
│   │   ├── VictoryScreen.tsx        # 100% completion modal
│   │   └── DevPanel.tsx             # Testing tools (hidden)
│   ├── lib/
│   │   ├── steam-api.ts             # Steam API utilities
│   │   ├── vault-logic.ts           # Game economy calculations
│   │   ├── storage.ts               # localStorage wrapper
│   │   └── constants.ts             # Formulas, magic numbers
│   ├── types/
│   │   ├── steam.ts                 # Steam API types
│   │   └── vault.ts                 # Idle game types
│   └── docs/
│       ├── game-design-document.md
│       ├── technical-design-document.md
│       └── milestone-plan.md
├── public/
│   └── vault-controller-icon.png    # Custom icon for fake game
├── .env.local                       # Steam API key
└── package.json
```

### **Relationship to Steam Stash:**
This is a **separate project** from Steam Stash:
- **Steam Stash:** Library analytics tool (separate codebase)
- **Steam Vault Escape:** Idle clicker game (this project)
- Both use Steam API but serve different purposes
- Can link between projects if deployed separately

---

## Data Models

### **SteamGame Interface:**
```typescript
interface SteamGame {
  appid: number;                    // Steam App ID
  name: string;                     // Game title
  playtime_forever: number;         // Total minutes played
  playtime_2weeks?: number;         // Minutes played last 2 weeks
  img_icon_url: string;             // Icon hash
  img_logo_url: string;             // Logo hash
  has_community_visible_stats?: boolean;
  rtime_last_played?: number;       // Unix timestamp
}
```

### **VaultGameState Interface:**
```typescript
interface VaultGameState {
  appid: number | string;           // 'vault-controller' or Steam App ID
  state: 'locked' | 'playable' | 'liberationKey';
  hoursPlayed: number;              // Calculated from playtime_forever
  unlockCost: number;               // Points needed to unlock
  passiveRate: number;              // Points per second
  clickValue: number;               // Points per click
  isFake?: boolean;                 // True for Vault Controller
}
```

### **VaultState Interface:**
```typescript
interface VaultState {
  points: number;                   // Current points balance
  unlockedGames: Array<number | string>; // App IDs of unlocked games
  featuredGame: number | string | null;  // Currently featured game
  cachedLibrary: SteamGame[];       // Last fetched library
  lastRefresh: number;              // Unix timestamp
  version: string;                  // Save format version
}
```

---

## Core Systems

### **1. Game State Management**

#### **State Classification Logic:**
```typescript
function classifyGame(
  game: SteamGame, 
  unlockedGames: Array<number | string>
): 'locked' | 'playable' | 'liberationKey' {
  
  // Vault Controller always playable
  if (game.appid === 'vault-controller') {
    return 'playable';
  }
  
  // Never played = Liberation Key
  if (game.playtime_forever === 0) {
    return 'liberationKey';
  }
  
  // Played but not unlocked = Locked
  if (!unlockedGames.includes(game.appid)) {
    return 'locked';
  }
  
  // Otherwise playable
  return 'playable';
}
```

#### **Game Stats Calculator:**
```typescript
function calculateGameStats(game: SteamGame): {
  hoursPlayed: number;
  unlockCost: number;
  passiveRate: number;
  clickValue: number;
} {
  const hours = game.playtime_forever / 60;
  
  return {
    hoursPlayed: hours,
    unlockCost: Math.floor(hours * hours * 0.5),
    passiveRate: Math.round(hours * 0.1 * 10) / 10,  // 1 decimal
    clickValue: Math.round(hours * 0.2 * 10) / 10,
  };
}
```

#### **Liberation Key Bonus:**
```typescript
function calculateLiberationBonus(minutesPlayed: number): number {
  return 50 + Math.floor(minutesPlayed * 0.5);
}
```

---

### **2. Steam API Integration**

#### **Library Fetch (Server-Side):**
```typescript
// src/app/api/steam-library/route.ts

export async function GET(request: NextRequest) {
  const steamId = request.nextUrl.searchParams.get('steamid');
  const apiKey = process.env.STEAM_API_KEY;
  
  const url = `https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/?key=${apiKey}&steamid=${steamId}&include_appinfo=1&include_played_free_games=1&format=json`;
  
  const response = await fetch(url);
  const data = await response.json();
  
  return NextResponse.json(data.response);
}
```

#### **Client-Side Fetch:**
```typescript
async function fetchSteamLibrary(steamId: string): Promise<SteamGame[]> {
  try {
    const response = await fetch(`/api/steam-library?steamid=${steamId}`);
    const data = await response.json();
    return data.games || [];
  } catch (error) {
    console.error('Failed to fetch Steam library:', error);
    throw error;
  }
}
```

#### **Auto-Refresh Logic:**
```typescript
useEffect(() => {
  if (!document.hasFocus()) return;
  
  const autoRefresh = setInterval(() => {
    const timeSinceRefresh = Date.now() - lastRefresh;
    
    // Auto-refresh every 5 minutes if tab focused
    if (timeSinceRefresh > 300000) {
      refreshLibrary();
    }
  }, 60000); // Check every minute
  
  return () => clearInterval(autoRefresh);
}, [lastRefresh]);
```

---

### **3. Liberation Key Detection**

#### **Unlock Detection Algorithm:**
```typescript
function detectNewUnlocks(
  newLibrary: SteamGame[],
  cachedLibrary: SteamGame[]
): Array<{ game: SteamGame; bonus: number }> {
  
  const newUnlocks: Array<{ game: SteamGame; bonus: number }> = [];
  
  newLibrary.forEach(newGame => {
    const cached = cachedLibrary.find(g => g.appid === newGame.appid);
    
    if (!cached) {
      // New game added to library (shouldn't happen often)
      return;
    }
    
    const oldMinutes = cached.playtime_forever;
    const newMinutes = newGame.playtime_forever;
    
    // Crossed 30-minute threshold?
    if (oldMinutes < 30 && newMinutes >= 30) {
      const bonus = calculateLiberationBonus(newMinutes);
      newUnlocks.push({ game: newGame, bonus });
    }
  });
  
  return newUnlocks;
}
```

#### **Unlock Handler:**
```typescript
function handleNewUnlocks(unlocks: Array<{ game: SteamGame; bonus: number }>) {
  unlocks.forEach(({ game, bonus }) => {
    // Add to unlocked games
    setUnlockedGames(prev => [...prev, game.appid]);
    
    // Award bonus points
    setPoints(prev => prev + bonus);
    
    // Show celebration modal
    showCelebration({
      gameName: game.name,
      minutesPlayed: game.playtime_forever,
      bonus: bonus,
      passiveRate: calculateGameStats(game).passiveRate
    });
  });
  
  // Save state
  saveToStorage();
}
```

---

### **4. Passive Income System**

#### **Income Calculator:**
```typescript
function calculateTotalPassive(
  games: SteamGame[],
  unlockedGames: Array<number | string>
): number {
  
  let total = 0;
  
  games.forEach(game => {
    if (unlockedGames.includes(game.appid)) {
      const stats = calculateGameStats(game);
      total += stats.passiveRate;
    }
  });
  
  // Add Vault Controller (always unlocked)
  total += 0.5;
  
  return Math.round(total * 10) / 10; // 1 decimal precision
}
```

#### **Passive Income Loop:**
```typescript
useEffect(() => {
  // Only generate if tab is focused
  const interval = setInterval(() => {
    if (document.hasFocus()) {
      const passiveIncome = calculateTotalPassive(games, unlockedGames);
      setPoints(prev => prev + passiveIncome);
    }
  }, 1000); // Every second
  
  return () => clearInterval(interval);
}, [games, unlockedGames]);
```

---

### **5. Click Handler**

#### **Featured Game Clicking:**
```typescript
function handleGameClick() {
  if (!featuredGame) return;
  
  const game = games.find(g => g.appid === featuredGame);
  if (!game) return;
  
  const stats = calculateGameStats(game);
  
  // Add points
  setPoints(prev => prev + stats.clickValue);
  
  // Show floating text animation
  showFloatingText(`+${stats.clickValue.toFixed(1)}`, 'points');
  
  // Trigger click animation
  triggerClickAnimation();
}
```

---

### **6. Unlock System**

#### **Unlock Handler:**
```typescript
function handleUnlock(game: SteamGame) {
  const stats = calculateGameStats(game);
  
  // Check if can afford
  if (points < stats.unlockCost) {
    showToast('Not enough points!', 'error');
    return;
  }
  
  // Deduct points
  setPoints(prev => prev - stats.unlockCost);
  
  // Add to unlocked
  setUnlockedGames(prev => [...prev, game.appid]);
  
  // Show unlock animation
  showUnlockAnimation(game);
  
  // Save state
  saveToStorage();
}
```

---

### **7. localStorage Persistence**

#### **Save Format:**
```typescript
const STORAGE_KEY = 'steamVaultState';
const STORAGE_VERSION = '1.0';

interface StoredState {
  version: string;
  points: number;
  unlockedGames: Array<number | string>;
  featuredGame: number | string | null;
  cachedLibrary: SteamGame[];
  lastRefresh: number;
}
```

#### **Save Function:**
```typescript
function saveToStorage(state: VaultState) {
  try {
    const serialized: StoredState = {
      version: STORAGE_VERSION,
      points: state.points,
      unlockedGames: state.unlockedGames,
      featuredGame: state.featuredGame,
      cachedLibrary: state.cachedLibrary,
      lastRefresh: state.lastRefresh,
    };
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(serialized));
  } catch (error) {
    console.error('Failed to save state:', error);
  }
}
```

#### **Load Function:**
```typescript
function loadFromStorage(): VaultState | null {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return null;
    
    const parsed: StoredState = JSON.parse(stored);
    
    // Version check
    if (parsed.version !== STORAGE_VERSION) {
      console.warn('Save version mismatch, clearing data');
      localStorage.removeItem(STORAGE_KEY);
      return null;
    }
    
    return {
      points: parsed.points,
      unlockedGames: parsed.unlockedGames,
      featuredGame: parsed.featuredGame,
      cachedLibrary: parsed.cachedLibrary,
      lastRefresh: parsed.lastRefresh,
      version: parsed.version,
    };
  } catch (error) {
    console.error('Failed to load state:', error);
    return null;
  }
}
```

#### **Auto-Save Timer:**
```typescript
useEffect(() => {
  const saveInterval = setInterval(() => {
    saveToStorage({
      points,
      unlockedGames,
      featuredGame,
      cachedLibrary: games,
      lastRefresh,
      version: STORAGE_VERSION,
    });
  }, 5000); // Every 5 seconds
  
  return () => clearInterval(saveInterval);
}, [points, unlockedGames, featuredGame, games, lastRefresh]);
```

---

## UI Components

### **1. TheVault.tsx (Main Component)**

**Responsibilities:**
- Orchestrates all sub-components
- Manages global state (points, unlocked, featured)
- Handles Steam library fetching
- Passive income loop
- Auto-save loop

**State:**
```typescript
const [points, setPoints] = useState(0);
const [unlockedGames, setUnlockedGames] = useState<Array<number | string>>(['vault-controller']);
const [featuredGame, setFeaturedGame] = useState<number | string | null>(null);
const [games, setGames] = useState<SteamGame[]>([]);
const [lastRefresh, setLastRefresh] = useState(Date.now());
const [isLoading, setIsLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
```

---

### **2. GameGrid.tsx (Virtual Scrolling)**

**Responsibilities:**
- Render game cards in virtual scrolling grid
- Handle filtering (All, Locked, Playable, Keys)
- Handle sorting (Cost, Hours, Name, Status)
- Performance optimization for 300+ games

**Props:**
```typescript
interface GameGridProps {
  games: VaultGameState[];
  onGameClick: (gameId: number | string) => void;
  onUnlock: (gameId: number | string) => void;
  onPlaySteam: (appId: number) => void;
  currentPoints: number;
}
```

**Virtual Scrolling Implementation:**
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

const parentRef = useRef<HTMLDivElement>(null);

const rowVirtualizer = useVirtualizer({
  count: Math.ceil(games.length / 6), // 6 games per row
  getScrollElement: () => parentRef.current,
  estimateSize: () => 200, // Estimated row height
  overscan: 2, // Render 2 extra rows for smooth scrolling
});
```

---

### **3. GameCard.tsx (Individual Game)**

**Responsibilities:**
- Display game capsule art
- Show state-specific UI (locked/playable/key)
- Handle click interactions
- State-based styling

**Props:**
```typescript
interface GameCardProps {
  game: VaultGameState;
  onClick: () => void;
  onUnlock?: () => void;
  onPlaySteam?: () => void;
  canAfford: boolean;
  isFeatured: boolean;
}
```

**Capsule Art URL:**
```typescript
const getCapsuleUrl = (appId: number | string): string => {
  if (appId === 'vault-controller') {
    return '/vault-controller-icon.png';
  }
  return `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/library_600x900.jpg`;
};
```

---

### **4. FeaturedGame.tsx**

**Responsibilities:**
- Display enlarged featured game
- Big click button
- Show click value prominently
- Click animations

**Props:**
```typescript
interface FeaturedGameProps {
  game: VaultGameState | null;
  onClickPlay: () => void;
  points: number;
}
```

---

### **5. VictoryScreen.tsx**

**Responsibilities:**
- Show 100% completion modal
- Display stats (total games, keys played, time invested)
- [CONTINUE PLAYING] button

**Props:**
```typescript
interface VictoryScreenProps {
  isOpen: boolean;
  onClose: () => void;
  stats: {
    totalGames: number;
    keysPlayed: number;
    totalPoints: number;
    mostExpensiveUnlock: { name: string; cost: number };
    highestPassiveGame: { name: string; rate: number };
    totalPassive: number;
  };
}
```

---

### **6. DevPanel.tsx (Hidden)**

**Responsibilities:**
- Add points instantly
- Unlock all games
- Speed up time (10x passive)
- Reset progress
- Hidden behind gear icon (bottom-right)

**Features:**
```typescript
- [+1000 Points] button
- [+10000 Points] button
- [Unlock All Cheap Games] button
- [Speed Up Time 10x] toggle
- [Reset All Progress] button (with confirmation)
```

---

## Performance Optimization

### **1. Virtual Scrolling**
- Only render visible games + overscan
- Lazy load game images
- Debounce scroll events

### **2. Memoization**
```typescript
const gameStats = useMemo(
  () => games.map(g => calculateGameStats(g)),
  [games]
);

const totalPassive = useMemo(
  () => calculateTotalPassive(games, unlockedGames),
  [games, unlockedGames]
);
```

### **3. Throttling**
```typescript
// Throttle click handler to prevent spam
const throttledClick = useCallback(
  throttle(handleGameClick, 100), // Max 10 clicks/sec
  [featuredGame, points]
);
```

### **4. Image Loading**
```typescript
<img
  src={getCapsuleUrl(appId)}
  loading="lazy"
  onError={(e) => {
    e.currentTarget.src = '/placeholder-game.png';
  }}
/>
```

---

## Error Handling

### **1. Steam API Failures**
```typescript
try {
  const library = await fetchSteamLibrary(steamId);
  setGames(library);
} catch (error) {
  // Use cached library
  const cached = loadFromStorage();
  if (cached?.cachedLibrary) {
    setGames(cached.cachedLibrary);
    setError('Using cached library. Steam API unavailable.');
  } else {
    setError('Failed to load library. Please try again.');
  }
}
```

### **2. localStorage Quota**
```typescript
try {
  saveToStorage(state);
} catch (error) {
  if (error.name === 'QuotaExceededError') {
    // Clear old data or compress
    console.error('Storage quota exceeded');
    showToast('Storage full. Some data may not save.', 'warning');
  }
}
```

### **3. Invalid Steam ID**
```typescript
if (!steamId || !/^\d{17}$/.test(steamId)) {
  setError('Invalid Steam ID format');
  return;
}
```

---

## Testing Strategy

### **Unit Tests:**
- `calculateGameStats()` with various hour values
- `classifyGame()` state logic
- `detectNewUnlocks()` threshold detection
- `calculateLiberationBonus()` bonus scaling

### **Integration Tests:**
- Save/load localStorage cycle
- Steam API fetch and parse
- Unlock flow (spend points, update state)
- Liberation Key detection

### **Manual Testing:**
- Test with small library (10 games)
- Test with large library (500+ games)
- Test edge cases (0 hours, 1000+ hours, no keys)
- Test offline behavior (no Steam API)
- Test victory condition (100% unlock)

---

## Deployment

### **Vercel Configuration:**
```javascript
// vercel.json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install"
}
```

### **Environment Variables:**
```bash
STEAM_API_KEY=your_steam_api_key_here
NEXT_PUBLIC_APP_URL=https://never-played.vercel.app
```

### **Build Process:**
```bash
# Install dependencies
npm install

# Build for production
npm run build

# Deploy to Vercel
vercel --prod
```

---

## Security Considerations

### **1. API Key Protection:**
- Steam API key in `.env.local` (never committed)
- Server-side API routes only (Next.js API)
- No client-side exposure

### **2. Input Validation:**
```typescript
function validateSteamId(steamId: string): boolean {
  // Must be 17-digit number
  return /^\d{17}$/.test(steamId);
}
```

### **3. Rate Limiting:**
```typescript
// Prevent spam refreshes
const MIN_REFRESH_INTERVAL = 10000; // 10 seconds

if (Date.now() - lastRefresh < MIN_REFRESH_INTERVAL) {
  showToast('Please wait before refreshing again', 'warning');
  return;
}
```

---

## Monitoring & Analytics

### **Key Metrics to Track:**
- Average session duration
- Games unlocked per session
- Liberation Keys played per user
- Victory screen reach rate
- Error rates (API failures, save errors)

### **Implementation (Future):**
```typescript
// Simple event tracking
function trackEvent(event: string, data?: any) {
  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('event', event, data);
  }
}

// Usage
trackEvent('game_unlocked', { cost: 1250, game: 'Skyrim' });
trackEvent('liberation_key_played', { game: 'Hollow Knight' });
trackEvent('victory_achieved', { totalGames: 342, hoursPlayed: 87 });
```

---

## Future Technical Enhancements

### **Performance:**
- Service Worker for offline support
- IndexedDB for larger data storage
- Web Workers for heavy calculations

### **Features:**
- WebSocket for real-time Steam updates
- Cloud save (optional user accounts)
- Export/import save data

### **Polish:**
- Canvas animations for particle effects
- Web Audio API for sound effects
- Lottie animations for celebrations

---

## Appendix: Constants & Formulas

```typescript
// src/lib/constants.ts

export const FORMULAS = {
  // Unlock cost: hours² × 0.5
  unlockCost: (hours: number) => Math.floor(hours * hours * 0.5),
  
  // Passive rate: hours × 0.1 (rounded to 1 decimal)
  passiveRate: (hours: number) => Math.round(hours * 0.1 * 10) / 10,
  
  // Click value: hours × 0.2 (rounded to 1 decimal)
  clickValue: (hours: number) => Math.round(hours * 0.2 * 10) / 10,
  
  // Liberation bonus: 50 + (minutes × 0.5)
  liberationBonus: (minutes: number) => 50 + Math.floor(minutes * 0.5),
};

export const THRESHOLDS = {
  LIBERATION_KEY_MINUTES: 30,     // Min play time to unlock key
  AUTO_REFRESH_INTERVAL: 300000,  // 5 minutes in ms
  SAVE_INTERVAL: 5000,            // 5 seconds in ms
  MIN_MANUAL_REFRESH: 10000,      // 10 seconds between manual refreshes
};

export const VAULT_CONTROLLER = {
  appid: 'vault-controller',
  name: 'The Vault Controller',
  playtime_forever: 300,          // Equivalent to 5 hours
  img_icon_url: 'vault-controller-icon',
  isFake: true,
};
```

---

**Document Version History:**
- v1.0 (2024-12-28): Initial technical design